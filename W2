import tkinter as tk
from tkinter import messagebox, ttk
import time
import math
import random


class JapaneseMahjong:
    """æ—¥æœ¬éº»å°‡è¨ˆç®—æ ¸å¿ƒ - é€²éšç‰ˆ"""
    
    SUIT_NAMES = {'m': 'è¬', 'p': 'ç­’', 's': 'ç´¢', 'z': 'å­—'}
    DRAGONS = {5: 'ç™½', 6: 'ç™¼', 7: 'ä¸­'}
    WINDS = {1: 'æ±', 2: 'å—', 3: 'è¥¿', 4: 'åŒ—'}
    
    YAKU_TABLE = {
        'ç«‹ç›´': {'fan': 1, 'display': 'ç«‹ç›´ (1ç•ª)'},
        'é–€å‰æ¸…è‡ªæ‘¸å’Œ': {'fan': 1, 'display': 'é–€å‰æ¸…è‡ªæ‘¸å’Œ (1ç•ª)'},
        'æ–·å¹ºä¹': {'fan': 1, 'display': 'æ–·å¹ºä¹ (1ç•ª)'},
        'å¹³å’Œ': {'fan': 1, 'display': 'å¹³å’Œ (1ç•ª)'},
        'ä¸€ç›ƒå£': {'fan': 1, 'display': 'ä¸€ç›ƒå£ (1ç•ª)'},
        'ç™½': {'fan': 1, 'display': 'ç™½ (1ç•ª)'},
        'ç™¼': {'fan': 1, 'display': 'ç™¼ (1ç•ª)'},
        'ä¸­': {'fan': 1, 'display': 'ä¸­ (1ç•ª)'},
        'é¢¨å­ï¼ˆè‡ªé¢¨ï¼‰': {'fan': 1, 'display': 'è‡ªé¢¨ (1ç•ª)'},
        'é¢¨å­ï¼ˆå ´é¢¨ï¼‰': {'fan': 1, 'display': 'å ´é¢¨ (1ç•ª)'},
        
        'ä¸‰è‰²åŒé †': {'fan': 2, 'display': 'ä¸‰è‰²åŒé † (2ç•ª)'},
        'ä¸€æ°£é€šè²«': {'fan': 2, 'display': 'ä¸€æ°£é€šè²« (2ç•ª)'},
        'æ··å…¨å¸¯å¹ºä¹': {'fan': 2, 'display': 'æ··å…¨å¸¯å¹ºä¹ (2ç•ª)'},
        'ä¸ƒå°å­': {'fan': 2, 'display': 'ä¸ƒå°å­ (2ç•ª)'},
        'å¯¾ã€…å’Œ': {'fan': 2, 'display': 'å¯¾ã€…å’Œ (2ç•ª)'},
        'ä¸‰æš—åˆ»': {'fan': 2, 'display': 'ä¸‰æš—åˆ» (2ç•ª)'},
        'ä¸‰è‰²åŒåˆ»': {'fan': 2, 'display': 'ä¸‰è‰²åŒåˆ» (2ç•ª)'},
        'æ··è€é ­': {'fan': 2, 'display': 'æ··è€é ­ (2ç•ª)'},
        'å°ä¸‰å…ƒ': {'fan': 2, 'display': 'å°ä¸‰å…ƒ (2ç•ª)'},
        
        'æ··ä¸€è‰²': {'fan': 3, 'display': 'æ··ä¸€è‰² (3ç•ª)'},
        'äºŒç›ƒå£': {'fan': 3, 'display': 'äºŒç›ƒå£ (3ç•ª)'},
        'ç´”å…¨å¸¯å¹ºä¹': {'fan': 3, 'display': 'ç´”å…¨å¸¯å¹ºä¹ (3ç•ª)'},
        
        'æ¸…ä¸€è‰²': {'fan': 6, 'display': 'æ¸…ä¸€è‰² (6ç•ª)'},
        
        'å¤§ä¸‰å…ƒ': {'fan': 13, 'display': 'å¤§ä¸‰å…ƒ (å½¹æ»¿)'},
        'å››æš—åˆ»': {'fan': 13, 'display': 'å››æš—åˆ» (å½¹æ»¿)'},
        'åœ‹å£«ç„¡é›™': {'fan': 13, 'display': 'åœ‹å£«ç„¡é›™ (å½¹æ»¿)'},
        'å¤§å››å–œ': {'fan': 13, 'display': 'å¤§å››å–œ (å½¹æ»¿)'},
        'å°å››å–œ': {'fan': 13, 'display': 'å°å››å–œ (å½¹æ»¿)'},
        'ä¹è“®å¯¶ç‡ˆ': {'fan': 13, 'display': 'ä¹è“®å¯¶ç‡ˆ (å½¹æ»¿)'},
        'å­—ä¸€è‰²': {'fan': 13, 'display': 'å­—ä¸€è‰² (å½¹æ»¿)'},
        'ç¶ ä¸€è‰²': {'fan': 13, 'display': 'ç¶ ä¸€è‰² (å½¹æ»¿)'},
        'æ¸…è€é ­': {'fan': 13, 'display': 'æ¸…è€é ­ (å½¹æ»¿)'},
    }

    BASE_POINTS = {
        1: {'tsumo': 1000, 'ron': 2000},
        2: {'tsumo': 2000, 'ron': 4000},
        3: {'tsumo': 3900, 'ron': 5800},
        4: {'tsumo': 7700, 'ron': 7700},
        5: {'tsumo': 8000, 'ron': 8000},
        6: {'tsumo': 12000, 'ron': 24000},
        8: {'tsumo': 16000, 'ron': 32000},
        11: {'tsumo': 24000, 'ron': 48000},
        13: {'tsumo': 32000, 'ron': 64000},
    }

    def parse_hand(self, input_str):
        """è§£ææ‰‹ç‰Œå­—ä¸²"""
        tiles = {'m': [], 'p': [], 's': [], 'z': []}
        input_str = input_str.replace(' ', '').strip()
        i = 0
        while i < len(input_str):
            numbers = []
            while i < len(input_str) and input_str[i].isdigit():
                numbers.append(int(input_str[i]))
                i += 1
            if i < len(input_str) and input_str[i] in 'mpsz':
                suit = input_str[i]
                i += 1
                for num in numbers:
                    tiles[suit].append(num)
        for suit in tiles:
            tiles[suit].sort()
        return tiles

    def _count_all(self, tiles):
        """çµ±è¨ˆæ¯å¼µç‰Œçš„æ•¸é‡"""
        counts = {}
        for s in tiles:
            for n in tiles[s]:
                key = (s, n)
                counts[key] = counts.get(key, 0) + 1
        return counts

    def _is_single_suit(self, tiles):
        """æª¢æŸ¥æ˜¯å¦åªæœ‰ä¸€ç¨®èŠ±è‰²ï¼ˆæ¸…ä¸€è‰²ï¼‰"""
        suit_count = 0
        for suit in ['m', 'p', 's']:
            if len(tiles[suit]) > 0:
                suit_count += 1
        # æ¸…ä¸€è‰²ï¼šåªæœ‰ä¸€ç¨®èŠ±è‰²çš„æ•¸å­—ç‰Œï¼ˆä¸å«å­—ç‰Œï¼‰
        return suit_count == 1 and len(tiles['z']) == 0

    def _check_green_only(self, tiles):
        """æª¢æŸ¥æ˜¯å¦ç‚ºç¶ ä¸€è‰²"""
        for s in tiles:
            for n in tiles[s]:
                if not ((s == 's' and n in [2, 3, 4, 6, 8]) or (s == 'z' and n == 6)):
                    return False
        total_tiles = sum(len(tiles[s]) for s in tiles)
        return total_tiles > 0

    def _check_all_honors(self, tiles):
        """æª¢æŸ¥æ˜¯å¦ç‚ºå­—ä¸€è‰²"""
        for s in ['m', 'p', 's']:
            if len(tiles[s]) > 0:
                return False
        return sum(len(tiles['z']) for _ in tiles) > 0

    def _check_all_terminals(self, tiles):
        """æª¢æŸ¥æ˜¯å¦ç‚ºæ¸…è€é ­"""
        allowed = {1, 9}
        for s in tiles:
            for n in tiles[s]:
                if s == 'z' or n not in allowed:
                    return False
        return sum(len(tiles[s]) for s in tiles) > 0

    def _check_thirteen_orphans(self, tiles):
        """æª¢æŸ¥æ˜¯å¦ç‚ºåœ‹å£«ç„¡é›™"""
        orphans = set()
        for s in ['m', 'p', 's']:
            orphans.add((s, 1))
            orphans.add((s, 9))
        for i in [1, 5, 6, 7]:
            orphans.add(('z', i))
        
        orphan_list = list(orphans)
        total = 0
        for s, n in orphan_list:
            total += tiles[s].count(n)
        
        return total == 14

    def _check_yakuman(self, tiles):
        """æª¢æŸ¥å½¹æ»¿"""
        yaku = []
        
        if self._check_green_only(tiles):
            yaku.append(('ç¶ ä¸€è‰²', 13))
            return yaku
        
        if self._check_all_honors(tiles):
            yaku.append(('å­—ä¸€è‰²', 13))
            return yaku
        
        if self._check_all_terminals(tiles):
            yaku.append(('æ¸…è€é ­', 13))
            return yaku
        
        if self._check_thirteen_orphans(tiles):
            yaku.append(('åœ‹å£«ç„¡é›™', 13))
            return yaku
        
        counts = self._count_all(tiles)
        triplets = 0
        dragons = 0
        winds = 0
        
        for k, v in counts.items():
            if v >= 3:
                triplets += 1
                if k[0] == 'z':
                    if k[1] in [5, 6, 7]:
                        dragons += 1
                    if k[1] in [1, 2, 3, 4]:
                        winds += 1
        
        if dragons == 3:
            yaku.append(('å¤§ä¸‰å…ƒ', 13))
        if winds == 4:
            yaku.append(('å¤§å››å–œ', 13))
        if triplets == 4:
            yaku.append(('å››æš—åˆ»', 13))
        
        return yaku

    def _analyze_hand(self, tiles):
        """å°‡æ‰‹ç‰Œåˆ†è§£ç‚ºæ‰€æœ‰å¯èƒ½çš„çµ„åˆ"""
        results = []
        
        pair_candidates = []
        for s in tiles:
            for n in set(tiles[s]):
                if tiles[s].count(n) >= 2:
                    pair_candidates.append((s, n))
        
        for p_suit, p_val in pair_candidates:
            rem_tiles = {s: tiles[s][:] for s in tiles}
            rem_tiles[p_suit].remove(p_val)
            rem_tiles[p_suit].remove(p_val)
            
            found_melds = self._get_melds_recursive(rem_tiles)
            for melds in found_melds:
                if len(melds) == 4:
                    results.append((melds, (p_suit, p_val)))
        
        return results

    def _get_melds_recursive(self, tiles):
        """éè¿´æ‰¾å‡ºæ‰€æœ‰é¢å­çµ„åˆ"""
        if sum(len(tiles[s]) for s in tiles) == 0:
            return [[]]
        
        first_suit = next((s for s in tiles if tiles[s]), None)
        if first_suit is None:
            return [[]]
        
        first_val = tiles[first_suit][0]
        possible_combinations = []
        
        if tiles[first_suit].count(first_val) >= 3:
            new_tiles = {s: tiles[s][:] for s in tiles}
            for _ in range(3):
                new_tiles[first_suit].remove(first_val)
            
            sub_results = self._get_melds_recursive(new_tiles)
            for res in sub_results:
                possible_combinations.append([('triplet', first_suit, first_val)] + res)
        
        if first_suit != 'z' and first_val <= 7:
            if (first_val + 1) in tiles[first_suit] and (first_val + 2) in tiles[first_suit]:
                new_tiles = {s: tiles[s][:] for s in tiles}
                new_tiles[first_suit].remove(first_val)
                new_tiles[first_suit].remove(first_val + 1)
                new_tiles[first_suit].remove(first_val + 2)
                
                sub_results = self._get_melds_recursive(new_tiles)
                for res in sub_results:
                    possible_combinations.append([('sequence', first_suit, first_val)] + res)
        
        return possible_combinations

    def calculate_fan(self, tiles, is_tsumo=True, is_menzen=True, is_riichi=False):
        """ä¸»è¨ˆç®—é‚è¼¯"""
        total_tiles = sum(len(tiles[s]) for s in tiles)
        if total_tiles != 14:
            raise ValueError(f"æ‰‹ç‰Œå¼µæ•¸éŒ¯èª¤ ({total_tiles}å¼µ)ï¼Œå¿…é ˆç‚º14å¼µ")

        yaku_list = []
        
        # 1. æª¢æŸ¥å½¹æ»¿
        yakuman_list = self._check_yakuman(tiles)
        if yakuman_list:
            return yakuman_list, sum(f for _, f in yakuman_list)

        # 2. æª¢æŸ¥ä¸ƒå°å­
        pair_count = sum(1 for s in tiles for n in set(tiles[s]) if tiles[s].count(n) == 2)
        if pair_count == 7:
            yaku_list.append(('ä¸ƒå°å­', 2))
            return yaku_list, 2

        # 3. æª¢æŸ¥æ¨™æº–ç‰Œå‹è§£æ
        structures = self._analyze_hand(tiles)
        
        if not structures:
            return [('ç„¡å½¹', 0)], 0
        
        best_yaku = []
        best_fan_total = 0
        
        for melds, pair in structures:
            current_yaku = []
            
            # æª¢æŸ¥æ¸…ä¸€è‰² - å¿…é ˆåœ¨æ¨™æº–ç‰Œå‹æª¢æ¸¬ä¸­
            if self._is_single_suit(tiles):
                current_yaku.append(('æ¸…ä¸€è‰²', 6))
            
            # æª¢æŸ¥å…¶ä»–åŸºæœ¬å½¹
            if is_riichi:
                current_yaku.append(('ç«‹ç›´', 1))
            if is_tsumo and is_menzen:
                current_yaku.append(('é–€å‰æ¸…è‡ªæ‘¸å’Œ', 1))
            
            total_fan = sum(f for _, f in current_yaku)
            
            if total_fan > best_fan_total:
                best_fan_total = total_fan
                best_yaku = current_yaku
        
        if not best_yaku:
            best_yaku = [('ç„¡å½¹', 0)]
        
        return best_yaku, sum(f for _, f in best_yaku)

    def get_points(self, fan, is_tsumo=True):
        """æ ¹æ“šç¿»æ•¸å’Œè´æ³•è¨ˆç®—å¾—é»"""
        if fan == 0:
            return 0
        
        if fan >= 13:
            fan = 13
        elif fan >= 11:
            fan = 11
        elif fan >= 8:
            fan = 8
        elif fan >= 6:
            fan = 6
        elif fan >= 5:
            fan = 5
        
        pts = self.BASE_POINTS.get(fan, self.BASE_POINTS[1])
        return pts['tsumo'] if is_tsumo else pts['ron']


class ModernStyle:
    """ç¾ä»£åŒ–è¨­è¨ˆé¢¨æ ¼"""
    PRIMARY_COLOR = "#1B4965"
    SECONDARY_COLOR = "#F18F01"
    ACCENT_COLOR = "#C73E1D"
    BG_COLOR = "#F6F5F0"
    CARD_BG = "#FFFFFF"
    TEXT_COLOR = "#2C3E50"
    LIGHT_TEXT = "#95A5A6"
    SUCCESS_COLOR = "#27AE60"
    TILE_COLOR = "#FF9800"


class MahjongGUI:
    """æ—¥æœ¬éº»å°‡è¨ˆç®—å™¨ - æŒ‰éˆ•æ’åˆ—ç‰ˆ"""
    
    TILE_DISPLAY = {
        'm': {i: f"{i}è¬" for i in range(1, 10)},
        'p': {i: f"{i}ç­’" for i in range(1, 10)},
        's': {i: f"{i}ç´¢" for i in range(1, 10)},
        'z': {1: 'æ±', 2: 'å—', 3: 'è¥¿', 4: 'åŒ—', 5: 'ç™½', 6: 'ç™¼', 7: 'ä¸­'}
    }
    
    def __init__(self, root):
        self.root = root
        self.root.title("æ—¥æœ¬éº»å°‡è¨ˆç®—å™¨")
        self.root.geometry("1200x900")
        self.root.configure(bg=ModernStyle.BG_COLOR)
        
        self.mahjong = JapaneseMahjong()
        self.selected_tiles = []
        
        # ç…™ç«ç›¸é—œ
        self.fireworks = []
        self.firework_canvas = None
        self.firework_animation_id = None
        self.firework_window = None
        self.firework_start_time = None
        
        self._setup_ui()
    
    def _setup_ui(self):
        """è¨­ç½®ä½¿ç”¨è€…ä»‹é¢"""
        # é ‚éƒ¨æ¨™é¡Œ
        self._setup_header()
        
        # ä¸»å®¹å™¨
        main_frame = tk.Frame(self.root, bg=ModernStyle.BG_COLOR)
        main_frame.pack(fill="both", expand=True, padx=0, pady=15)
        
        # ä¸­é–“ä¸Šæ–¹ï¼šç‰Œé¸æ“‡å€åŸŸï¼ˆæ©«å‘æ’åˆ—ï¼‰
        self._setup_tiles_selection(main_frame)
        
        # ä¸­é–“ä¸‹æ–¹ï¼šé¸é …å’Œæ§åˆ¶æŒ‰éˆ•
        self._setup_control_panel(main_frame)
        
        # ä¸‹æ–¹ï¼šçµæœé¡¯ç¤º
        self._setup_result_frame(main_frame)
    
    def _setup_header(self):
        """è¨­ç½®é ‚éƒ¨æ¨™é¡Œå€åŸŸ"""
        header_frame = tk.Frame(self.root, bg=ModernStyle.PRIMARY_COLOR, height=70)
        header_frame.pack(fill="x", padx=0, pady=0)
        header_frame.pack_propagate(False)
        
        title_label = tk.Label(
            header_frame,
            text="ğŸ² æ—¥æœ¬éº»å°‡è¨ˆç®—å™¨",
            font=("Segoe UI", 22, "bold"),
            bg=ModernStyle.PRIMARY_COLOR,
            fg="white"
        )
        title_label.pack(pady=12)
    
    def _setup_tiles_selection(self, parent):
        """è¨­ç½®ç‰Œé¸æ“‡å€åŸŸï¼ˆæ©«å‘æ’åˆ—ï¼‰"""
        # è¬å­å€åŸŸ
        self._create_tile_section(parent, "è¬", 'm', range(1, 10))
        
        # ç­’å­å€åŸŸ
        self._create_tile_section(parent, "ç­’", 'p', range(1, 10))
        
        # ç´¢å­å€åŸŸ
        self._create_tile_section(parent, "ç´¢", 's', range(1, 10))
        
        # å­—ç‰Œå€åŸŸ
        honor_tiles = [(1, 'æ±'), (2, 'å—'), (3, 'è¥¿'), (4, 'åŒ—'), 
                       (5, 'ç™½'), (6, 'ç™¼'), (7, 'ä¸­')]
        self._create_honor_tile_section(parent, "å­—ç‰Œ", 'z', honor_tiles)
    
    def _create_tile_section(self, parent, name, suit, numbers):
        """å»ºç«‹ç‰Œå€åŸŸ"""
        # æ¨™é¡Œå’ŒæŒ‰éˆ•å®¹å™¨
        section_frame = tk.Frame(parent, bg=ModernStyle.BG_COLOR)
        section_frame.pack(fill="x", padx=20, pady=10)
        
        # æ¨™é¡Œ
        title_label = tk.Label(
            section_frame,
            text=f"â— {name}",
            font=("Segoe UI", 12, "bold"),
            bg=ModernStyle.BG_COLOR,
            fg=ModernStyle.PRIMARY_COLOR,
            width=6
        )
        title_label.pack(side="left", padx=(0, 15))
        
        # æŒ‰éˆ•å®¹å™¨ï¼ˆå¯æ»¾å‹•å€åŸŸï¼‰
        buttons_frame = tk.Frame(section_frame, bg=ModernStyle.BG_COLOR)
        buttons_frame.pack(side="left", fill="x", expand=True)
        
        # å»ºç«‹æŒ‰éˆ•
        for num in numbers:
            btn = tk.Button(
                buttons_frame,
                text=str(num),
                command=lambda x=num: self._add_tile(suit, x),
                font=("Segoe UI", 11, "bold"),
                bg=ModernStyle.TILE_COLOR,
                fg="white",
                activebackground=ModernStyle.SECONDARY_COLOR,
                relief="flat",
                padx=14,
                pady=12,
                width=4,
                height=2,
                cursor="hand2",
                bd=0
            )
            btn.pack(side="left", padx=4)
    
    def _create_honor_tile_section(self, parent, name, suit, honor_list):
        """å»ºç«‹å­—ç‰Œå€åŸŸ"""
        section_frame = tk.Frame(parent, bg=ModernStyle.BG_COLOR)
        section_frame.pack(fill="x", padx=20, pady=10)
        
        title_label = tk.Label(
            section_frame,
            text=f"â— {name}",
            font=("Segoe UI", 12, "bold"),
            bg=ModernStyle.BG_COLOR,
            fg=ModernStyle.PRIMARY_COLOR,
            width=6
        )
        title_label.pack(side="left", padx=(0, 15))
        
        buttons_frame = tk.Frame(section_frame, bg=ModernStyle.BG_COLOR)
        buttons_frame.pack(side="left", fill="x", expand=True)
        
        for num, label in honor_list:
            btn = tk.Button(
                buttons_frame,
                text=label,
                command=lambda x=num: self._add_tile(suit, x),
                font=("Segoe UI", 11, "bold"),
                bg=ModernStyle.TILE_COLOR,
                fg="white",
                activebackground=ModernStyle.SECONDARY_COLOR,
                relief="flat",
                padx=14,
                pady=12,
                width=4,
                height=2,
                cursor="hand2",
                bd=0
            )
            btn.pack(side="left", padx=4)
    
    def _setup_control_panel(self, parent):
        """è¨­ç½®æ§åˆ¶é¢æ¿"""
        control_frame = tk.Frame(parent, bg=ModernStyle.BG_COLOR)
        control_frame.pack(fill="x", padx=20, pady=(20, 10))
        
        # å·¦å´ï¼šç•¶å‰æ‰‹ç‰Œé¡¯ç¤º
        info_frame = tk.Frame(control_frame, bg=ModernStyle.CARD_BG)
        info_frame.pack(side="left", fill="both", expand=True, padx=(0, 10))
        
        info_title = tk.Label(
            info_frame,
            text="ç•¶å‰æ‰‹ç‰Œ",
            font=("Segoe UI", 10, "bold"),
            bg=ModernStyle.CARD_BG,
            fg=ModernStyle.PRIMARY_COLOR
        )
        info_title.pack(anchor="w", padx=10, pady=(8, 5))
        
        self.hand_display = tk.Label(
            info_frame,
            text="é»æ“Šä¸Šæ–¹æŒ‰éˆ•é¸æ“‡ç‰Œ (0/14)",
            font=("Courier New", 10),
            bg=ModernStyle.CARD_BG,
            fg=ModernStyle.TEXT_COLOR,
            justify="left",
            wraplength=300
        )
        self.hand_display.pack(anchor="w", padx=10, pady=(5, 8))
        
        # ä¸­é–“ï¼šé¸é …
        option_frame = tk.Frame(control_frame, bg=ModernStyle.CARD_BG)
        option_frame.pack(side="left", fill="both", expand=True, padx=10)
        
        option_title = tk.Label(
            option_frame,
            text="è¨ˆç®—é¸é …",
            font=("Segoe UI", 10, "bold"),
            bg=ModernStyle.CARD_BG,
            fg=ModernStyle.PRIMARY_COLOR
        )
        option_title.pack(anchor="w", padx=10, pady=(8, 5))
        
        options_inner = tk.Frame(option_frame, bg=ModernStyle.CARD_BG)
        options_inner.pack(anchor="w", padx=10, pady=(5, 8))
        
        self.is_tsumo = tk.BooleanVar(value=True)
        self.is_menzen = tk.BooleanVar(value=True)
        self.is_riichi = tk.BooleanVar(value=False)
        
        checkbox_style = {
            'bg': ModernStyle.CARD_BG,
            'fg': ModernStyle.TEXT_COLOR,
            'font': ("Segoe UI", 9),
            'activebackground': ModernStyle.CARD_BG,
            'activeforeground': ModernStyle.PRIMARY_COLOR
        }
        
        tk.Checkbutton(options_inner, text="è‡ªæ‘¸", variable=self.is_tsumo, **checkbox_style).pack(anchor="w")
        tk.Checkbutton(options_inner, text="é–€å‰æ¸…", variable=self.is_menzen, **checkbox_style).pack(anchor="w")
        tk.Checkbutton(options_inner, text="ç«‹ç›´", variable=self.is_riichi, **checkbox_style).pack(anchor="w")
        
        # å³å´ï¼šæŒ‰éˆ•
        button_frame = tk.Frame(control_frame, bg=ModernStyle.BG_COLOR)
        button_frame.pack(side="left", fill="both", expand=True, padx=(10, 0))
        
        tk.Button(
            button_frame,
            text="è¨ˆç®—",
            command=self.calculate,
            font=("Segoe UI", 11, "bold"),
            bg=ModernStyle.PRIMARY_COLOR,
            fg="white",
            activebackground="#143852",
            relief="flat",
            padx=20,
            pady=15,
            cursor="hand2",
            bd=0
        ).pack(side="top", fill="both", expand=True, padx=(0, 5), pady=(0, 5))
        
        tk.Button(
            button_frame,
            text="æ’¤éŠ·",
            command=self._remove_last_tile,
            font=("Segoe UI", 10),
            bg=ModernStyle.LIGHT_TEXT,
            fg="white",
            activebackground="#7F8C8D",
            relief="flat",
            padx=15,
            pady=10,
            cursor="hand2",
            bd=0
        ).pack(side="left", fill="both", expand=True, padx=2)
        
        tk.Button(
            button_frame,
            text="æ¸…ç©º",
            command=self._clear_all,
            font=("Segoe UI", 10),
            bg=ModernStyle.ACCENT_COLOR,
            fg="white",
            activebackground="#A72C1A",
            relief="flat",
            padx=15,
            pady=10,
            cursor="hand2",
            bd=0
        ).pack(side="left", fill="both", expand=True, padx=2)
    
    def _setup_result_frame(self, parent):
        """è¨­ç½®çµæœå€åŸŸ"""
        result_frame = tk.Frame(parent, bg=ModernStyle.CARD_BG)
        result_frame.pack(fill="both", expand=True, padx=20, pady=10)
        
        result_title = tk.Label(
            result_frame,
            text="è¨ˆç®—çµæœ",
            font=("Segoe UI", 11, "bold"),
            bg=ModernStyle.CARD_BG,
            fg=ModernStyle.PRIMARY_COLOR
        )
        result_title.pack(anchor="w", padx=10, pady=(8, 5))
        
        text_frame = tk.Frame(result_frame, bg=ModernStyle.CARD_BG)
        text_frame.pack(fill="both", expand=True, padx=10, pady=(5, 10))
        
        self.result_text = tk.Text(
            text_frame,
            font=("Courier New", 10),
            bg=ModernStyle.CARD_BG,
            fg=ModernStyle.TEXT_COLOR,
            relief="flat",
            padx=10,
            pady=10,
            wrap="word",
            height=12
        )
        self.result_text.pack(side="left", fill="both", expand=True)
        self.result_text.config(state="disabled")
        
        scrollbar = tk.Scrollbar(text_frame, command=self.result_text.yview, bg=ModernStyle.BG_COLOR)
        scrollbar.pack(side="right", fill="y")
        self.result_text.config(yscrollcommand=scrollbar.set)
        
        self.result_text.tag_config("title", foreground=ModernStyle.PRIMARY_COLOR, font=("Courier New", 10, "bold"))
        self.result_text.tag_config("yaku", foreground=ModernStyle.SUCCESS_COLOR, font=("Courier New", 10))
        self.result_text.tag_config("yakuman", foreground=ModernStyle.ACCENT_COLOR, font=("Courier New", 10, "bold"))
        self.result_text.tag_config("points", foreground=ModernStyle.SECONDARY_COLOR, font=("Courier New", 10, "bold"))
        self.result_text.tag_config("error", foreground=ModernStyle.ACCENT_COLOR)
    
    def _add_tile(self, suit, number):
        """æ·»åŠ ç‰Œ"""
        if len(self.selected_tiles) < 14:
            self.selected_tiles.append((suit, number))
            self._update_hand_display()
    
    def _remove_last_tile(self):
        """ç§»é™¤æœ€å¾Œä¸€å¼µç‰Œ"""
        if self.selected_tiles:
            self.selected_tiles.pop()
            self._update_hand_display()
    
    def _clear_all(self):
        """æ¸…é™¤æ‰€æœ‰ç‰Œ"""
        self.selected_tiles = []
        self._update_hand_display()
        self.result_text.config(state="normal")
        self.result_text.delete("1.0", "end")
        self.result_text.config(state="disabled")
    
    def _update_hand_display(self):
        """æ›´æ–°æ‰‹ç‰Œé¡¯ç¤º"""
        tiles_by_suit = {'m': [], 'p': [], 's': [], 'z': []}
        for suit, num in self.selected_tiles:
            tiles_by_suit[suit].append(num)
        
        display_text = ""
        suit_icons = {'m': 'ğŸ”´', 'p': 'ğŸŸ¡', 's': 'ğŸŸ¢', 'z': 'âšª'}
        suit_names = {'m': 'è¬', 'p': 'ç­’', 's': 'ç´¢', 'z': 'å­—ç‰Œ'}
        
        for suit in ['m', 'p', 's', 'z']:
            if tiles_by_suit[suit]:
                nums = ' '.join(str(n) for n in tiles_by_suit[suit])
                display_text += f"{suit_icons[suit]} {suit_names[suit]}: {nums}  "
        
        if not display_text:
            display_text = "é»æ“Šä¸Šæ–¹æŒ‰éˆ•é¸æ“‡ç‰Œ"
        
        display_text += f"\n({len(self.selected_tiles)}/14)"
        self.hand_display.config(text=display_text)
    
    def _generate_fireworks(self, width, height):
        """ç”Ÿæˆç…™ç«ç²’å­"""
        self.fireworks = []
        colors = ["#FFD700", "#FF6B6B", "#4ECDC4", "#95E1D3", "#F7DC6F", "#FF85A2"]
        
        center_x, center_y = width // 2, height // 2
        
        for _ in range(60):
            angle = random.uniform(0, 2 * math.pi)
            speed = random.uniform(3, 8)
            vx = math.cos(angle) * speed
            vy = math.sin(angle) * speed
            
            self.fireworks.append({
                'x': center_x,
                'y': center_y,
                'vx': vx,
                'vy': vy,
                'life': 1.0,
                'color': random.choice(colors),
                'size': random.randint(4, 10)
            })
    
    def _show_fireworks(self):
        """é¡¯ç¤ºç…™ç«å‹•ç•«"""
        self._stop_fireworks()
        
        x = self.root.winfo_rootx()
        y = self.root.winfo_rooty()
        w = self.root.winfo_width()
        h = self.root.winfo_height()
        
        self.firework_window = tk.Toplevel(self.root)
        self.firework_window.geometry(f"{w}x{h}+{x}+{y}")
        self.firework_window.overrideredirect(True)
        self.firework_window.attributes("-topmost", True)
        
        TRANS_COLOR = "#f0f0f0"
        self.firework_window.configure(bg=TRANS_COLOR)
        try:
            self.firework_window.attributes("-transparentcolor", TRANS_COLOR)
        except Exception:
            pass
        
        self.firework_canvas = tk.Canvas(
            self.firework_window,
            bg="#0a0e27",
            highlightthickness=0
        )
        self.firework_canvas.pack(fill="both", expand=True)
        
        self._generate_fireworks(w, h)
        
        center_x, center_y = w // 2, h // 2
        
        self.firework_canvas.create_text(
            center_x, center_y - 60,
            text="å½¹ æ»¿",
            font=("Arial", 100, "bold"),
            fill="#FFD700"
        )
        
        self.firework_canvas.create_text(
            center_x, center_y + 80,
            text="æ­å–œé”æˆå½¹æ»¿ï¼",
            font=("Arial", 28),
            fill="#FF85A2"
        )
        
        self.firework_start_time = time.time()
        self._animate_fireworks()
    
    def _animate_fireworks(self):
        """å‹•ç•«å¾ªç’°"""
        if self.firework_canvas is None or self.firework_window is None:
            return
        
        elapsed = time.time() - self.firework_start_time
        
        if elapsed > 3.5:
            self._stop_fireworks()
            return
        
        self.firework_canvas.delete("particle")
        
        center_x = self.firework_canvas.winfo_width() // 2
        center_y = self.firework_canvas.winfo_height() // 2
        
        self.firework_canvas.create_text(
            center_x, center_y - 60,
            text="å½¹ æ»¿",
            font=("Arial", 100, "bold"),
            fill="#FFD700"
        )
        
        for particle in self.fireworks:
            particle['vy'] += 0.15
            particle['x'] += particle['vx']
            particle['y'] += particle['vy']
            particle['life'] -= 0.018
            
            if particle['life'] > 0:
                color = particle['color']
                self.firework_canvas.create_oval(
                    particle['x'] - particle['size'],
                    particle['y'] - particle['size'],
                    particle['x'] + particle['size'],
                    particle['y'] + particle['size'],
                    fill=color,
                    outline=color
                )
        
        self.firework_animation_id = self.firework_window.after(25, self._animate_fireworks)
    
    def _stop_fireworks(self):
        """åœæ­¢ç…™ç«å‹•ç•«"""
        if self.firework_animation_id:
            try:
                self.firework_window.after_cancel(self.firework_animation_id)
            except:
                pass
            self.firework_animation_id = None
        
        if self.firework_window:
            try:
                self.firework_window.destroy()
            except:
                pass
            self.firework_window = None
        
        self.firework_canvas = None
        self.fireworks = []
    
    def _insert_result(self, text: str, tag: str = ""):
        """å‘çµæœæ¡†æ’å…¥æ–‡æœ¬"""
        self.result_text.config(state="normal")
        self.result_text.insert("end", text, tag)
        self.result_text.config(state="disabled")
    
    def calculate(self):
        """è¨ˆç®—ä¸»å‡½æ•¸"""
        if len(self.selected_tiles) != 14:
            messagebox.showwarning(
                "è­¦å‘Š",
                f"æ‰‹ç‰Œæ•¸é‡éŒ¯èª¤\néœ€è¦14å¼µï¼Œç›®å‰{len(self.selected_tiles)}å¼µ",
                parent=self.root
            )
            return
        
        try:
            tiles = {'m': [], 'p': [], 's': [], 'z': []}
            for suit, num in self.selected_tiles:
                tiles[suit].append(num)
            
            for suit in tiles:
                tiles[suit].sort()
            
            yaku_list, total_fan = self.mahjong.calculate_fan(
                tiles,
                is_tsumo=self.is_tsumo.get(),
                is_menzen=self.is_menzen.get(),
                is_riichi=self.is_riichi.get()
            )
            
            points_tsumo = self.mahjong.get_points(total_fan, is_tsumo=True)
            points_ron = self.mahjong.get_points(total_fan, is_tsumo=False)
            
            self.result_text.config(state="normal")
            self.result_text.delete("1.0", "end")
            self.result_text.config(state="disabled")
            
            # ç¾åŒ–çµæœè¼¸å‡º
            self._insert_result("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n", "title")
            self._insert_result("â•‘   è¨ˆç®—çµæœ      â•‘\n", "title")
            self._insert_result("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n", "title")
            
            self._insert_result("ã€ æ‰‹ç‰Œ ã€‘\n", "title")
            suit_icons = {'m': 'ğŸ”´', 'p': 'ğŸŸ¡', 's': 'ğŸŸ¢', 'z': 'âšª'}
            suit_names = {'m': 'è¬', 'p': 'ç­’', 's': 'ç´¢', 'z': 'å­—'}
            
            for suit in ['m', 'p', 's', 'z']:
                if tiles[suit]:
                    self._insert_result(f"  {suit_icons[suit]} {suit_names[suit]}: ")
                    for num in tiles[suit]:
                        self._insert_result(f"{num} ")
                    self._insert_result("\n")
            
            self._insert_result("\nã€ å½¹ç¨® ã€‘\n", "title")
            for yaku, fan in yaku_list:
                tag = "yakuman" if fan >= 13 else "yaku"
                self._insert_result(f"  âœ“ {yaku} ({fan}ç•ª)\n", tag)
            
            self._insert_result(f"\nã€ ç¿»æ•¸ ã€‘\n", "title")
            self._insert_result(f"  {total_fan} ç•ª\n", "points")
            
            self._insert_result(f"\nã€ å¾—é» ã€‘\n", "title")
            self._insert_result(f"  è‡ªæ‘¸: {points_tsumo} é»\n", "points")
            self._insert_result(f"  æ”¾æ§: {points_ron} é»\n", "points")
            
            if total_fan >= 13:
                self._show_fireworks()
        
        except Exception as e:
            self.result_text.config(state="normal")
            self.result_text.delete("1.0", "end")
            self.result_text.config(state="disabled")
            self._insert_result(f"âŒ ç™¼ç”ŸéŒ¯èª¤: {str(e)}", "error")


if __name__ == "__main__":
    root = tk.Tk()
    gui = MahjongGUI(root)
    root.mainloop()

